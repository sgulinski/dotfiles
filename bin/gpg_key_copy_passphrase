#!/usr/bin/env bash
set -e

script_path="$( cd $( dirname $0 ) && pwd )"
script_name=$(basename $0)

if [ -f $script_path/../.extra ]; then
  source $script_path/../.extra
elif [ -f $script_path/../../extra/.extra ]; then
  source $script_path/../../extra/.extra
else
  echo "Error: missing $script_path/../.extra and $script_path/../../extra/.extra"
  exit 1
fi

[ ! -z "$LPASS_USERNAME" ] \
  || { echo "Error: \$LPASS_USERNAME not set in `.extra`"; exit 1; }

check_parameters() {
  if [[ $# -ne 0 ]]; then
    echo $"Incorrect number of parameters provided ($#)" >&2
    echo $'\nUsage:' >&2
    echo $"  $script_name" >&2
    exit 1
  fi
}

lpass_command_exists() {
  command -v lpass >/dev/null 2>&1
}

check_lpass_command_exists() {
  if ! lpass_command_exists; then
    echo "lpass (command line interface for LastPass) required, but not found. " \
      "Aborting" >&2
    exit 1
  fi
}

logout_from_lpass() {
  lpass status | grep -q $LPASS_USERNAME && logged_to_lpass=$? || logged_to_lpass=$?

  if [[ $logged_to_lpass -eq 0 ]]; then
    echo 'Logging out from LastPass'
    lpass logout -f
  fi
}

catch() {
  if [[ $1 -ne 0 ]]; then
    echo "Error ($1) occurred in line $2 of $script_name"
    logout_from_lpass
  fi
}

copy_gpg_key_passphrase() {
  trap 'catch $? $LINENO' EXIT

  lpass status | grep -q $LPASS_USERNAME || logged_to_lpass=$?

  if [[ $logged_to_lpass -ne 0 ]]; then
    echo 'Logging to LastPass'
    lpass login $LPASS_USERNAME
  fi

  echo 'Copying passphrase for private gpg key to clipboard'
  lpass show --clip --field=Passphrase gpg

  logout_from_lpass
}

main() {
  check_parameters $@
  check_lpass_command_exists
  copy_gpg_key_passphrase
}

main $@
